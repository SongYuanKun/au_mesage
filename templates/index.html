<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶é‡‘ä»·ç›‘æ§ç³»ç»Ÿ - è‡ªåŠ¨è®¡ç®—</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
<div class="container">

    {% include '_nav.html' %}
    <div class="content">

        <div class="card">
            <div class="type-selector">
                <button id="typeGold" class="active" data-type="é»„ é‡‘">é»„ é‡‘</button>
                <button id="typeSilver" data-type="ç™½ é“¶">ç™½ é“¶</button>
            </div>
            <!--            -->
                        <h4 id="currentPriceTitle">ğŸ“Š å®æ—¶é»„é‡‘ä»·æ ¼</h4> <!-- Added ID for dynamic update -->
                        <div class="price-display">
                            <div class="current-price" id="currentPrice">åŠ è½½ä¸­...</div>
                            <div class="last-update" id="lastUpdate"></div>
                        </div>

            <!--            <div class="chart-container">-->
            <!--                <div id="priceChart" style="width: 100%; height: 100%;"></div>-->
            <!--            </div>-->
            <!--        </div>-->

            <!--        <div class="card">-->
            <!--            <h2>ğŸ§® ä»·æ ¼è®¡ç®—å™¨</h2>-->
            <!--            <div class="auto-calc-notice">-->
            <!--                ğŸ’¡ è¾“å…¥ä»·æ ¼å’Œå…‹é‡åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—ä»·æ ¼å·®ï¼Œæ— éœ€ç‚¹å‡»æŒ‰é’®-->
            <!--            </div>-->
            <div class="calculator-form">
                <div class="form-group">
                    <label for="productPrice">å•†å“æ€»ä»·ï¼ˆå…ƒï¼‰:</label>
                    <input type="number" id="productPrice" placeholder="è¯·è¾“å…¥å•†å“æ€»ä»·æ ¼" step="0.01"
                           inputmode="decimal" pattern="[0-9]*">
                </div>

                <div class="form-group">
                    <label for="weight">å•†å“å…‹é‡ï¼ˆå…‹ï¼‰:</label>
                    <input type="number" id="weight" placeholder="è¯·è¾“å…¥å•†å“é‡é‡" step="0.01" inputmode="decimal"
                           pattern="[0-9]*">
                </div>
            </div>

            <div class="result" id="result">
                <h3>è®¡ç®—ç»“æœ</h3>
                <div class="price-info">
                    <div class="price-item">
                        <div>æ¯å…‹ä»·æ ¼</div>
                        <div id="pricePerGram">-</div>
                    </div>
                    <div class="price-item">
                        <div>å¤§ç›˜é‡‘ä»·</div>
                        <div id="marketPrice">-</div>
                    </div>
                </div>
                <div class="difference" id="differenceDisplay">
                    ä»·æ ¼å·®: - å…ƒ/å…‹
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // é˜²æŠ–å‡½æ•°å®ç°
    function debounce(func, wait) {
        let timeout;
        return function () {
            const context = this;
            const args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function () {
                func.apply(context, args);
            }, wait);
        };
    }

    // åˆå§‹åŒ–å›¾è¡¨
    const chartDom = document.getElementById('priceChart');
    // const priceChart = echarts.init(chartDom);

    let currentDataType = 'é»„ é‡‘'; // Default to Gold

    // Update title based on selected type
    function updateTitle(type) {
        document.getElementById('currentPriceTitle').textContent = `ğŸ“Š å®æ—¶${type}å›æ”¶ä»·æ ¼`;
    }

    // Update price display
    function updatePriceDisplay() {
        fetch(`/api/latest-price?data_type=${currentDataType}`) // Pass data_type
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    document.getElementById('currentPrice').textContent =
                        `${data.data.recycle_price} å…ƒ/å…‹`;

                    if (data.data.created_at) { // Use created_at from the database
                        const updateTime = new Date(data.data.created_at).toLocaleString('zh-CN');
                        document.getElementById('lastUpdate').textContent =
                            `æœ€åæ›´æ–°: ${updateTime}`;
                    }
                } else {
                    document.getElementById('currentPrice').textContent = 'è·å–å¤±è´¥';
                    document.getElementById('lastUpdate').textContent = '';
                    console.error('è·å–é‡‘ä»·å¤±è´¥:', data.error);
                }
            })
            .catch(error => {
                console.error('è·å–é‡‘ä»·å¤±è´¥:', error);
                document.getElementById('currentPrice').textContent = 'è·å–å¤±è´¥';
                document.getElementById('lastUpdate').textContent = '';
            });
    }

    // Update price history chart (now using /api/recent-history)
    function updatePriceChart() {
        fetch(`/api/recent-history?data_type=${currentDataType}`) // Changed to /api/recent-history
            .then(response => response.json())
            .then(history => {
                if (history.success && history.data) {
                    const dates = history.data.map(item =>
                        new Date(item.created_at).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})
                    );
                    const prices = history.data.map(item => item.recycle_price);

                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            formatter: '{b}<br/>ä»·æ ¼: {c} å…ƒ/å…‹'
                        },
                        xAxis: {
                            type: 'category',
                            data: dates,
                            axisLabel: {
                                rotate: 45
                            }
                        },
                        yAxis: {
                            type: 'value',
                            name: 'ä»·æ ¼ (å…ƒ/å…‹)'
                        },
                        series: [{
                            data: prices,
                            type: 'line',
                            smooth: true,
                            lineStyle: {
                                width: 3,
                                color: '#4a86e8'
                            },
                            areaStyle: {
                                color: {
                                    type: 'linear',
                                    x: 0, y: 0, x2: 0, y2: 1,
                                    colorStops: [{
                                        offset: 0, color: 'rgba(74, 134, 232, 0.5)'
                                    }, {
                                        offset: 1, color: 'rgba(74, 134, 232, 0.1)'
                                    }]
                                }
                            }
                        }],
                        grid: {
                            left: '5%',
                            right: '5%',
                            bottom: '15%',
                            top: '10%'
                        }
                    };

                    priceChart.setOption(option);
                } else {
                    console.error('è·å–å†å²æ•°æ®å¤±è´¥:', history.error);
                    priceChart.clear(); // Clear chart if no data
                }
            })
            .catch(error => {
                console.error('è·å–å†å²æ•°æ®å¤±è´¥:', error);
                priceChart.clear(); // Clear chart on error
            });
    }

    // Calculate difference function
    function calculateDifference() {
        const productPrice = parseFloat(document.getElementById('productPrice').value);
        const weight = parseFloat(document.getElementById('weight').value);

        // If any input is empty or invalid, hide the result
        if (isNaN(productPrice) || isNaN(weight) || weight <= 0) {
            document.getElementById('result').style.display = 'none';
            return;
        }

        fetch('/api/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                product_price: productPrice,
                weight: weight,
                data_type: currentDataType // Pass data_type to calculation
            })
        })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    document.getElementById('result').style.display = 'none';
                    console.error('è®¡ç®—å¤±è´¥:', result.error);
                    return;
                }

                document.getElementById('pricePerGram').textContent =
                    `${result.price_per_gram.toFixed(2)} å…ƒ/å…‹`;
                document.getElementById('marketPrice').textContent =
                    `${result.market_price.toFixed(2)} å…ƒ/å…‹`;

                const differenceElement = document.getElementById('differenceDisplay');
                const difference = result.difference.toFixed(2);
                const total_difference = result.total_difference.toFixed(2);
                const differencePercentage = result.difference_percentage.toFixed(2);

                differenceElement.textContent = `æ€»æ”¶ç›Š: ${0 - total_difference}`;
                // differenceElement.textContent = `ä»·æ ¼å·®: ${difference} å…ƒ/å…‹ (${differencePercentage}%)`;

                if (result.difference < 0) {
                    differenceElement.className = 'difference negative';
                    // differenceElement.innerHTML += '<br>ğŸ’¡ æ¯”å¤§ç›˜ä»·æ ¼ä¾¿å®œ';
                } else if (result.difference > 0) {
                    differenceElement.className = 'difference positive';
                    // differenceElement.innerHTMLrHTML += '<br>ğŸ’¡ æ¯”å¤§ç›˜ä»·æ ¼è´µ';
                } else {
                    differenceElement.className = 'difference'; // Neutral style if no difference
                    // differenceElement.innerHTML += '<br>ğŸ’¡ ä¸å¤§ç›˜ä»·æ ¼æŒå¹³';
                }

                document.getElementById('result').style.display = 'block';
            })
            .catch(error => {
                console.error('è®¡ç®—å¤±è´¥:', error);
                document.getElementById('result').style.display = 'none';
            });
    }

    // Debounced auto-calculation function
    const debouncedCalculate = debounce(calculateDifference, 300);

    // Function to handle type selection
    function selectType(type) {
        currentDataType = type;
        updateTitle(type); // Update the title
        // Update active button class
        document.querySelectorAll('.type-selector button').forEach(button => {
            if (button.dataset.type === type) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
        // Re-fetch data and recalculate for the new type
        updatePriceDisplay();
        // updatePriceChart();
        debouncedCalculate(); // Recalculate with new type
    }

    // Page load initialization
    document.addEventListener('DOMContentLoaded', function () {
        // Initial load for default type (Gold)
        selectType(currentDataType);

        // Event listeners for type selection buttons
        document.getElementById('typeGold').addEventListener('click', () => selectType('é»„ é‡‘'));
        document.getElementById('typeSilver').addEventListener('click', () => selectType('ç™½ é“¶'));

        // Add input event listeners for calculator
        document.getElementById('productPrice').addEventListener('input', debouncedCalculate);
        document.getElementById('weight').addEventListener('input', debouncedCalculate);

        // ä½¿ç”¨å˜é‡å­˜å‚¨å®šæ—¶å™¨IDï¼Œæ–¹ä¾¿ç®¡ç†
        let priceUpdateInterval;
        let chartUpdateInterval;

        // æ›´æ–°ä»·æ ¼çš„å‡½æ•°ï¼ˆå¸¦å¯è§æ€§æ£€æµ‹ï¼‰
        function startPriceUpdate() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval);
            }
            
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡
            updatePriceDisplay();
            
            // è®¾ç½®å®šæ—¶å™¨ï¼šæ¯30ç§’æ›´æ–°ä¸€æ¬¡
            priceUpdateInterval = setInterval(function() {
                // åªåœ¨é¡µé¢å¯è§æ—¶æ›´æ–°ï¼ˆç§»åŠ¨æµè§ˆå™¨ä¼˜åŒ–ï¼‰
                if (!document.hidden) {
                    updatePriceDisplay();
                }
            }, 30000);
        }

        // æ›´æ–°å›¾è¡¨çš„å‡½æ•°ï¼ˆå¸¦å¯è§æ€§æ£€æµ‹ï¼‰
        function startChartUpdate() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (chartUpdateInterval) {
                clearInterval(chartUpdateInterval);
            }
            
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡
            // updatePriceChart(); // å›¾è¡¨å·²æ³¨é‡Šï¼Œæš‚æ—¶ä¸æ‰§è¡Œ
            
            // è®¾ç½®å®šæ—¶å™¨ï¼šæ¯2åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
            chartUpdateInterval = setInterval(function() {
                // åªåœ¨é¡µé¢å¯è§æ—¶æ›´æ–°ï¼ˆç§»åŠ¨æµè§ˆå™¨ä¼˜åŒ–ï¼‰
                if (!document.hidden) {
                    // updatePriceChart(); // å›¾è¡¨å·²æ³¨é‡Šï¼Œæš‚æ—¶ä¸æ‰§è¡Œ
                }
            }, 120000);
        }

        // å¯åŠ¨å®šæ—¶æ›´æ–°
        startPriceUpdate();
        startChartUpdate();

        // ä½¿ç”¨ Page Visibility API ä¼˜åŒ–ç§»åŠ¨æµè§ˆå™¨ä½“éªŒ
        // å½“é¡µé¢ä»åå°åˆ‡æ¢åˆ°å‰å°æ—¶ï¼Œç«‹å³æ›´æ–°æ•°æ®
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œç«‹å³æ›´æ–°ä»·æ ¼
                updatePriceDisplay();
                // é‡æ–°å¯åŠ¨å®šæ—¶å™¨ï¼ˆé˜²æ­¢åå°æ—¶è¢«èŠ‚æµï¼‰
                startPriceUpdate();
                startChartUpdate();
            }
        });

        // Resize chart on window resize
        window.addEventListener('resize', function () {
            // priceChart.resize(); // å›¾è¡¨å·²æ³¨é‡Šï¼Œæš‚æ—¶ä¸æ‰§è¡Œ
        });
    });
</script>
</body>
</html>